<script>
  const form = document.getElementById('form');
  const container = document.getElementById('videos');
  const errorBox = document.getElementById('error');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    let input = document.getElementById('channelId').value.trim();
    if (!input) return;

    let channelId = null;

    if (input.startsWith('@')) {
      // Username seperti @saipulanuar
      input = 'https://www.youtube.com/' + input;
    }

    if (input.startsWith('http')) {
      try {
        const url = new URL(input);
        const parts = url.pathname.split('/');
        if (parts[1] === 'channel' && parts[2]) {
          channelId = parts[2];
        } else if (parts[1].startsWith('@')) {
          const username = parts[1];
          // Ambil channel_id dari username menggunakan fetch
          const res = await fetch(`https://www.youtube.com/${username}`);
          const text = await res.text();
          const match = text.match(/channel_id=([\w\-]+)/);
          if (match && match[1]) {
            channelId = match[1];
          } else {
            throw new Error('Gagal menemukan channel_id dari username.');
          }
        } else {
          throw new Error('Format URL tidak dikenali.');
        }
      } catch (err) {
        errorBox.textContent = '‚ùå URL tidak valid atau username tidak ditemukan.';
        container.innerHTML = '';
        return;
      }
    } else {
      // Anggap input langsung adalah channel_id
      channelId = input;
    }

    if (!channelId) {
      errorBox.textContent = '‚ùå Gagal mengekstrak channel_id.';
      container.innerHTML = '';
      return;
    }

    errorBox.textContent = '';
    container.innerHTML = '<p>üîÑ Memuat video...</p>';

    const rssUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`;
    const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;

    try {
      const res = await fetch(apiUrl);
      const data = await res.json();

      if (!data.items || data.items.length === 0) {
        throw new Error('Tidak ada video ditemukan.');
      }

      container.innerHTML = '';
      let counter = 0;

      for (let item of data.items) {
        if (counter >= 20) break;
        if (item.link.includes('/shorts/')) continue;

        const videoId = item.link.split('=')[1];
        const title = item.title;
        const thumbnail = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="thumbnail">
            <img src="${thumbnail}" alt="Thumbnail">
          </div>
          <div class="title">${title}</div>
          <a class="btn" href="https://api.saipulanuar.eu.org/api/ytdl?url=https://www.youtube.com/watch?v=${videoId}&type=mp3" target="_blank">Download MP3</a>
          <a class="btn btn-video" href="https://api.saipulanuar.eu.org/api/ytdl?url=https://www.youtube.com/watch?v=${videoId}&type=mp4" target="_blank">Download Video</a>
        `;
        container.appendChild(card);
        counter++;
      }
    } catch (err) {
      console.error(err);
      errorBox.textContent = '‚ùå Gagal mengambil video dari channel.';
      container.innerHTML = '';
    }
  });
</script>
