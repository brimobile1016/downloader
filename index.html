<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>YouTube MP3 Downloader</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .video-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        .btn { display: inline-block; padding: 5px 10px; background: #007BFF; color: #fff; text-decoration: none; margin-right: 5px; }
        .btn-video { background: #28a745; }
    </style>
</head>
<body>
    <h1>üéµ YouTube Channel MP3 Downloader</h1>
    <form id="searchForm">
        <input type="text" id="input" placeholder="Masukkan @username, channel ID, atau URL video/channel" style="width: 100%;" required>
        <button type="submit">Cari</button>
    </form>
    <div id="result"></div>

    <script>
        const form = document.getElementById('searchForm');
        const resultDiv = document.getElementById('result');

        function extractChannelId(input) {
            if (input.startsWith('@')) {
                return fetch(`https://www.youtube.com/${input}`)
                    .then(res => res.text())
                    .then(html => {
                        const match = html.match(/"channelId":"(UC[0-9A-Za-z_-]+)"/);
                        if (match) return match[1];
                        throw new Error("Channel ID tidak ditemukan dari @username");
                    });
            } else if (input.includes('youtube.com/channel/')) {
                return Promise.resolve(input.split('/channel/')[1].split(/[/?]/)[0]);
            } else if (input.startsWith('UC')) {
                return Promise.resolve(input);
            } else {
                return Promise.reject("Input bukan channel ID");
            }
        }

        function isYouTubeVideoUrl(url) {
            return url.includes('watch?v=');
        }

        function fetchDownloadLinks(videoId) {
            return fetch(`https://api.saipulanuar.eu.org/api/download/ytdl?url=https://www.youtube.com/watch?v=${videoId}`)
                .then(res => res.json());
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            resultDiv.innerHTML = '‚è≥ Memuat...';
            const input = document.getElementById('input').value.trim();

            try {
                // Jika input adalah URL video
                if (isYouTubeVideoUrl(input)) {
                    const videoId = new URL(input).searchParams.get('v');
                    const data = await fetchDownloadLinks(videoId);
                    if (!data.status) throw new Error("Gagal mengambil data video");

                    const { title, thumbnail, author, mp3, mp4 } = data.result;
                    resultDiv.innerHTML = `
                        <div class="video-card">
                            <img src="${thumbnail}" width="200"><br>
                            <b>${title}</b><br>
                            <i>${author}</i><br>
                            <a class="btn" href="${mp3}" target="_blank">Download MP3</a>
                            <a class="btn btn-video" href="${mp4}" target="_blank">Download Video</a>
                        </div>`;
                    return;
                }

                // Jika input channel
                const channelId = await extractChannelId(input);
                const rssUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`;
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`);
                const data = await res.json();
                const parser = new DOMParser();
                const xml = parser.parseFromString(data.contents, "text/xml");

                const items = Array.from(xml.getElementsByTagName("entry"));
                const filtered = items.filter(el => {
                    const link = el.getElementsByTagName("link")[0].getAttribute("href");
                    return !link.includes("shorts");
                }).slice(0, 15); // Ambil maksimal 15 bukan shorts

                if (!filtered.length) throw new Error("Tidak ada video ditemukan");

                resultDiv.innerHTML = '';
                for (const item of filtered) {
                    const title = item.getElementsByTagName("title")[0].textContent;
                    const link = item.getElementsByTagName("link")[0].getAttribute("href");
                    const videoId = new URL(link).searchParams.get("v");
                    const thumbnail = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;

                    const apiRes = await fetchDownloadLinks(videoId);
                    const { mp3, mp4 } = apiRes.result;

                    resultDiv.innerHTML += `
                        <div class="video-card">
                            <img src="${thumbnail}" width="200"><br>
                            <b>${title}</b><br>
                            <a class="btn" href="${mp3}" target="_blank">Download MP3</a>
                            <a class="btn btn-video" href="${mp4}" target="_blank">Download Video</a>
                        </div>
                    `;
                }
            } catch (err) {
                console.error(err);
                resultDiv.innerHTML = `‚ùå ${err.message}`;
            }
        });
    </script>
</body>
</html>
